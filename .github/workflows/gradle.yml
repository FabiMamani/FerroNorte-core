name: Java CI Pipeline

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: chmod +x ./gradlew
      - name: Build
        run: ./gradlew clean assemble

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: chmod +x ./gradlew

      - name: Run Tests
        run: ./gradlew test

      # --- Guardar reportes de test ---
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build/reports/tests/test

      # ------------------------------------------------------
      #     ðŸ“„ GENERAR REPORTE VISIBLE EN GITHUB
      # ------------------------------------------------------
      - name: Generate GitHub Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          total=$(grep -R "<testsuite" build/test-results/test | wc -l)
          failures=$(grep -R "failures=\"[1-9]" build/test-results/test | wc -l)
          errors=$(grep -R "errors=\"[1-9]" build/test-results/test | wc -l)

          echo "**Test suites ejecutadas:** $total" >> $GITHUB_STEP_SUMMARY
          echo "**Fallos:** $failures" >> $GITHUB_STEP_SUMMARY
          echo "**Errores:** $errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ $failures -eq 0 && $errors -eq 0 ]]; then
            echo "### âœ… Resultado: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Resultado: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Informe HTML disponible en Artifacts â†’ test-report**" >> $GITHUB_STEP_SUMMARY


  publish:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - uses: gradle/actions/setup-gradle@v4
      - run: chmod +x ./gradlew
      - name: Publish to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
